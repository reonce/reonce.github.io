---
title: antd树形多选引发的思考
date: 2022-7-27
author: reonce
tags: 感悟
location: 成都  
---

## 需求背景

 一个树形多选组件，当子节点全部选中的时候，只传父节点的值，否则传子节点

## 错误判断

因为在ng-zorro中，这个逻辑是默认的，于是我很爽快的答应了后端这样做。但是在antd react版本中，子节点全选中会把所有子节点和父节点都传出，和需求商讨的方案是不同的，于是我需要自己实现。

## 技术实现分析

在选中或取消某个节点时，可以拿到当前节点的树结构和对应关系。

1. 当节点作为父节点时，通过对应关系，很容易去过滤去掉它的子节点。

2. 当节点作为子节点时，**难点**来了，需要判断它的兄弟节点及它兄弟节点的全部子节点是否全部选中，如果全部选中，还要用当前节点的父节点作为**父节点的逻辑**还要再走作为**子节点**的逻辑

## 思考 

在充分调研技术之前，不要马虎的答应，那样不够沉稳，并且容易给自己带来麻烦。

当陷入预估错误带来的后果时，有两种解决方案：

1. 自己解决。拼脑力体力解决掉问题，为”吹出去的牛逼“付出代价
2. 重新商讨，求后端改方案。需要好声好气的去找后端同学在商讨方案

两种方案都是被动的局面，十分窘迫。

**其实这些”坏结果”完全是可避免的，如果我认真查看了antd的树组件逻辑，开始就和后端商量好，后端来做数据逻辑处理，就可以避免这个窘境了。**

## 实现过程

好吧，于是我只能选择自己解决掉问题，尽管最终的解决思路异常的简单轻松，但是想到这个思路之前我还是做了许多无用的方案。

首先看看antd的树形选择到底有没有提供这种方案，在我认知里，只应该也是很常见的传值方案啊（以前做过angular的项目，逻辑是如此）。官网文档没有我就看源码，于是最终把tree的源码拉下来，调试了一遍发现，它确实没有提供这个API。正常受控组件只抛出了**选中的值**和**选中的节点**对象们。如果我选择父子组件不关联，那么基本就凉凉了，按照上面的分析十分难实现。于是我仔细研究了返回的树结构想到下列算法处理。



实际上我使用antd的**受控组件**时，只传父节点它也会帮我处理掉。我只需要选择的时候过滤掉“兄弟节点全选中的子节点们”。那么我根据树结构是否有children，如果有，把里面的值存到一个`Set`结构中，最后做一个过滤即可。核心代码如下：
~~~ts
 const onCheck = (checkedKeysValue: KeyType[], e: any) => {
    const childrenSet = new Set();
    const checkedNodes = e.checkedNodes;
    checkedNodes?.forEach((node: RealDataNode) => {
      const curChildren = node?.children;
      if (curChildren && !!curChildren?.length) {
        curChildren.forEach((childNode) => {
          const curKey = childNode.uid;
          if (!childrenSet.has(curKey)) {
            childrenSet.add(curKey);
          }
        });
      }
    });
    const handledKeys = checkedKeysValue.filter(
      (key: KeyType) => !childrenSet.has(key)
    );
    setCheckedKeys(handledKeys);
    onChange?.(handledKeys);
  };
~~~

实现之后回头看，其实非常简单。这不禁让我思考到第二层，承担更多的难点问题会有更进一步的提高，而且这种提高是**被逼着提高**，很有成效

所以最重要的是要有自信，相信自己的能力，在时间允许的条件下多思考，无时无刻的去想，问题解决的时机就是思路跳动的一瞬间。
